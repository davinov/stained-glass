(function(){var t;t=function(){function t(t,i){var o;this.img=t,this.options=i,o=this.img,this.width=o.width,this.height=o.height,this.mapImageColors(),this.generateDistribution()}return t.prototype.polygon=function(t){return"M"+t.join("L")+"Z"},t.prototype.generateDistribution=function(){var t,i,o,n;return o=this.options.polygons||100,i=(this.width-1)/Math.sqrt(o),t=(this.height-1)/Math.sqrt(o),null==(null!=(n=this.options)?n.deviation:void 0)&&(this.options.deviation=.2),this.vertices=d3.range(this.options.polygons||100).map(function(o){return function(n,s){var e,h,r,a,d,p;return r=Math.floor(s%(o.width/t)),a=Math.floor(s/o.width*t),e=r*t+t/2,h=a*i+i/2,d=d3.random.normal(e,t*o.options.deviation)(),p=d3.random.normal(h,i*o.options.deviation)(),o.ensureInBounds(d,p)}}(this)),this.voronoi=d3.geom.voronoi().clipExtent([[0,0],[this.width,this.height]]),d3.select(this.img).style({display:"none"}),this.svg=d3.select(this.img.parentNode).append("svg").attr("width",this.width).attr("height",this.height).classed("stained-glass",!0),this.pathGroup=this.svg.append("g"),this.updateDistribution()},t.prototype.updateDistribution=function(){var t;return t=this.pathGroup.selectAll("path").data(this.voronoi(this.vertices),this.polygon),t.exit().remove(),t.enter().append("path").attr("d",this.polygon).style("stroke-width",this.options.strokeWidth||1.51),t.order(),this.updateColors()},t.prototype.updateColors=function(){return this.pathGroup.selectAll("path").each(function(t){return function(i){var o;return o=t.getImageColors(Math.round(i.point[0]),Math.round(i.point[1])),i.color="rgb("+o[0]+","+o[1]+","+o[2]+")"}}(this)).attr("fill",function(t){return t.color}).style("stroke",function(t){return function(i){return t.options.stroke?t.options.stroke:i.color}}(this)).style("stroke-width",this.options.strokeWidth||1.51)},t.prototype.mapImageColors=function(){return this.canvas=document.createElement("canvas"),this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.getContext("2d").drawImage(this.img,0,0,this.width,this.height)},t.prototype.getImageColors=function(t,i){var o;return o=this.ensureInBounds(t,i),t=o[0],i=o[1],this.canvas.getContext("2d").getImageData(t,i,1,1).data},t.prototype.ensureInBounds=function(t,i){return t=d3.max([0,t]),i=d3.max([0,i]),t=d3.min([t,this.width-1]),i=d3.min([i,this.height-1]),[t,i]},t}(),window.StainedGlass=t}).call(this);