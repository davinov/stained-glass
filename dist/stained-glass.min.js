(function(){var t;t=function(){function t(t,i){var o;this.img=t,this.options=i,o=this.img,this.width=o.width,this.height=o.height,null==this.options&&(this.options={}),this.mapImageColors(),this.generateDistribution()}return t.prototype.polygon=function(t){return"M"+t.join("L")+"Z"},t.prototype.generateDistribution=function(){var t,i,o,s,n,e,h;for(this.polygonNumber=this.options.polygons||100,n=(this.width-1)/Math.sqrt(this.polygonNumber),i=(this.height-1)/Math.sqrt(this.polygonNumber),null==(null!=(e=this.options)?e.deviation:void 0)&&(this.options.deviation=.2),this.vertices=d3.range(this.polygonNumber).map(function(t){return function(o,s){var e,h,r,a,u,p;return r=Math.floor(s%(t.width/i)),a=Math.floor(s/t.width*i),e=r*i+i/2,h=a*n+n/2,u=d3.random.normal(e,i*t.options.deviation)(),p=d3.random.normal(h,n*t.options.deviation)(),t.ensureInBounds(u,p)}}(this)),this.options.triangles?(this.vertices=this.vertices.concat(this.calculateSidePoints()),this.geom=d3.geom.delaunay):this.geom=d3.geom.voronoi().clipExtent([[0,0],[this.width,this.height]]),this.svg=d3.select(this.img.parentNode).insert("svg","img").attr("height",this.height).attr("width",this.width).style({display:"inline-block"}).classed("stained-glass",!0),d3.select(this.img).style({display:"none"}),h=this.img.classList,o=0,s=h.length;s>o;o++)t=h[o],this.svg.classed(t,!0);return this.pathGroup=this.svg.append("g"),this.updateDistribution()},t.prototype.updateDistribution=function(){var t;return t=this.pathGroup.selectAll("path").data(this.geom(this.vertices),this.polygon),t.exit().remove(),t.enter().append("path").attr("d",this.polygon).style("stroke-width",this.options.strokeWidth||1.51),t.order(),this.updateColors()},t.prototype.updateColors=function(){var t,i,o,s,n;return t=d3.random.normal(0,10),this.options.animationDuration||(this.options.animationDuration=2e3),o=function(i){return function(s,n,e){var h,r,a;return a=d3.select(s),a.each(function(t){var o,s,n;return t.point||(t.point=[(t[0][0]+t[1][0]+t[2][0])/3,(t[0][1]+t[1][1]+t[2][1])/3]),s=Math.round(t.point[0]+e[0]),n=Math.round(t.point[1]+e[1]),o=i.getImageColors(s,n),t.color="rgb("+o[0]+","+o[1]+","+o[2]+")"}),h=n?0:i.options.animationDuration,r=a.transition().ease("linear").duration(h).attr("fill",function(t){return t.color}).style("stroke",function(t){return i.options.stroke?i.options.stroke:t.color}).style("stroke-width",i.options.strokeWidth||1.51),i.options.animated&&!i.options.followCursor?r.each("end",function(){return o(this,!1,[t(),t()])}):void 0}}(this),this.pathGroup.selectAll("path").each(function(){return o(this,!0,[0,0])}),this.options.followCursor?(i=this,s=i.width/i.height/i.polygonNumber*10,n=i.height/i.width/i.polygonNumber*10,this.pathGroup.on("mousemove",function(){var t,e;return t=d3.mouse(this)[0],e=d3.mouse(this)[1],i.pathGroup.selectAll("path").each(function(i){return o(this,!1,[(i.point[0]-t)*s,(i.point[1]-e)*n])})})):void 0},t.prototype.mapImageColors=function(){return this.canvas=document.createElement("canvas"),this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.getContext("2d").drawImage(this.img,0,0,this.width,this.height)},t.prototype.getImageColors=function(t,i){var o;return o=this.ensureInBounds(t,i),t=o[0],i=o[1],this.canvas.getContext("2d").getImageData(t,i,1,1).data},t.prototype.ensureInBounds=function(t,i){return t=d3.max([0,t]),i=d3.max([0,i]),t=d3.min([t,this.width-1]),i=d3.min([i,this.height-1]),[t,i]},t.prototype.calculateSidePoints=function(){var t,i,o,s,n,e,h,r,a,u,p;for(t=Math.sqrt(this.polygonNumber)*this.width/this.height,h=Math.sqrt(this.polygonNumber)*this.height/this.width,e=[],r=i=0,s=t;s>=0?s>=i:i>=s;r=s>=0?++i:--i)a=r*this.width/t,e.push([a,0]),e.push([a,this.height-1]);for(u=o=0,n=h;n>=0?n>=o:o>=n;u=n>=0?++o:--o)p=u*this.height/h,e.push([0,p]),e.push([this.width-1,p]);return e.push([this.width-1,this.height-1]),e},t}(),window.StainedGlass=t}).call(this);