(function(){var t;t=function(){function t(t,i){var o;this.img=t,this.options=i,o=this.img,this.width=o.width,this.height=o.height,null==this.options&&(this.options={}),this.mapImageColors(),this.generateDistribution()}return t.prototype.polygon=function(t){return"M"+t.join("L")+"Z"},t.prototype.generateDistribution=function(){var t,i,o,s,n,e,h,r;for(e=this.options.polygons||100,n=(this.width-1)/Math.sqrt(e),i=(this.height-1)/Math.sqrt(e),null==(null!=(h=this.options)?h.deviation:void 0)&&(this.options.deviation=.2),this.vertices=d3.range(this.options.polygons||100).map(function(t){return function(o,s){var e,h,r,a,d,p;return r=Math.floor(s%(t.width/i)),a=Math.floor(s/t.width*i),e=r*i+i/2,h=a*n+n/2,d=d3.random.normal(e,i*t.options.deviation)(),p=d3.random.normal(h,n*t.options.deviation)(),t.ensureInBounds(d,p)}}(this)),this.voronoi=d3.geom.voronoi().clipExtent([[0,0],[this.width,this.height]]),this.svg=d3.select(this.img.parentNode).insert("svg").attr("height",this.height).attr("width",this.width).style({display:"inline-block"}).classed("stained-glass",!0),d3.select(this.img).style({display:"none"}),r=this.img.classList,o=0,s=r.length;s>o;o++)t=r[o],this.svg.classed(t,!0);return this.pathGroup=this.svg.append("g"),this.updateDistribution()},t.prototype.updateDistribution=function(){var t;return t=this.pathGroup.selectAll("path").data(this.voronoi(this.vertices),this.polygon),t.exit().remove(),t.enter().append("path").attr("d",this.polygon).style("stroke-width",this.options.strokeWidth||1.51),t.order(),this.updateColors()},t.prototype.updateColors=function(){return this.pathGroup.selectAll("path").each(function(t){return function(i){var o;return o=t.getImageColors(Math.round(i.point[0]),Math.round(i.point[1])),i.color="rgb("+o[0]+","+o[1]+","+o[2]+")"}}(this)).attr("fill",function(t){return t.color}).style("stroke",function(t){return function(i){return t.options.stroke?t.options.stroke:i.color}}(this)).style("stroke-width",this.options.strokeWidth||1.51)},t.prototype.mapImageColors=function(){return this.canvas=document.createElement("canvas"),this.canvas.width=this.width,this.canvas.height=this.height,this.canvas.getContext("2d").drawImage(this.img,0,0,this.width,this.height)},t.prototype.getImageColors=function(t,i){var o;return o=this.ensureInBounds(t,i),t=o[0],i=o[1],this.canvas.getContext("2d").getImageData(t,i,1,1).data},t.prototype.ensureInBounds=function(t,i){return t=d3.max([0,t]),i=d3.max([0,i]),t=d3.min([t,this.width-1]),i=d3.min([i,this.height-1]),[t,i]},t}(),window.StainedGlass=t}).call(this);